## 小红书爆款笔记多 Agent 生成项目设计文档

### 1. 项目背景与目标

**1.1 背景**

在现有企业级生成式 AI 应用框架（FastAPI + CrewAI 多 Agent 编排）的基础上，本项目面向“小红书爆款笔记创作”这一垂直场景，构建一套端到端的自动化内容生产能力。  
核心目标是：**用户通过 API 一次提交笔记创作意图（文本）与多张图片（每次请求上传多张图片），即可自动生成一份结构化的小红书笔记撰写报告**，包括：

- **笔记标题**：符合小红书平台风格，含 Emoji；
- **正文内容**：分段清晰、具情绪价值与互动引导；
- **标签（tags）**：5–8 个可用于搜索与话题分发的标签；
- **图片列表**：按发布顺序输出，并为每张图片生成
  - **视觉分析结果**；
  - **图片编辑与 P 图方案**。

**1.2 业务目标**

- 面向内容团队 / MCN 机构，提供可直接嵌入业务工作流的爆款笔记“策划 + 撰写 + SEO + 视觉指导”一体化服务；
- 所有关键中间产物（视觉分析、编辑方案、策略简报、文案、SEO 优化结果）均通过 **Pydantic 模型结构化输出**，便于存储与二次加工；
- 充分复用当前项目的企业级能力：配置管理、日志与可观测性、鉴权与限流等。

---

### 2. 整体架构与模块划分

**2.1 与现有框架的集成位置**

在现有目录规范（见《Python AI 应用框架设计文档》）基础上，本项目新增 / 复用模块如下：

- `app/api/v1/xhs_note.py`：  
  - 定义 HTTP API（如 `POST /api/v1/xhs/notes/report`），处理请求解析、鉴权、入参校验与响应封装；
- `app/schemas/xhs_note.py`：  
  - 定义本项目所有 Pydantic 模型，包括请求、响应和内部领域模型；
- `app/crews/xhs_note/agents.py`：  
  - 定义所有小红书相关 Agent 的 LLM、tools、multimodal 等绑定；**角色文案（role/goal/backstory）来自 `app/crews/config/agents.yaml`**，由本模块加载后传入 CrewAI Agent；
- `app/crews/xhs_note/tasks.py`：  
  - 定义与业务场景对应的 Task 及**按单图构建 Task 的工厂函数**（如 `build_visual_analysis_task`、`build_image_edit_task`），Task 描述与预期输出从 `app/crews/config/tasks.yaml` 加载；
- `app/crews/xhs_note/flows.py`：  
  - 定义**三阶段编排**：视觉分析阶段（多图并发）、编辑方案阶段（多图并发）、内容阶段（策略→文案→SEO 顺序），每阶段使用独立 Crew，最终报告在 Python 内汇总为字符串；
- `app/services/xhs_note_service.py`：  
  - 对外提供领域服务接口，负责将 HTTP 请求转化为 CrewAI 调用，封装错误处理与观测埋点；
- （可选）`app/db/repositories/xhs_note_repo.py`：  
  - 若需要落库存档，可在后续版本实现历史报告的持久化。

**2.2 请求–响应链路概览**

1. 客户端通过 `POST /api/v1/xhs/notes/report` 以 **multipart/form-data** 上送：
   - 文本形式的创作意图 / 草稿（form 字段 `idea_text`）；
   - **多张图片**（每次请求在 form 中上传多张，同一字段名 `images` 多文件）；
2. API 层完成鉴权（X-API-Key）、参数校验后，将上传的图片写入临时目录，组装为领域模型 `XhsNoteIdeaRequest`；
3. 调用 `run_xhs_note_flow(idea_request)`（异步）：
   - **阶段一**：为每张图片创建视觉分析 Task，同一 Crew 内 sequential 执行（含汇总 Task），得到每图 `XhsImageVisualAnalysis` 及汇总摘要；
   - **阶段二**：为每张图片创建编辑方案 Task，同一 Crew 内 sequential 执行（含汇总 Task），得到每图 `XhsImageEditPlan` 及汇总摘要；
   - **阶段三**：单 Crew 内顺序执行内容策略、文案撰写、SEO 优化三个 Task，入参通过 `crew.akickoff(inputs={...})` 注入视觉/编辑批次报告；
   - 最终在 `flows.py` 内由 `_generate_final_report(...)` 将上述结构化结果**汇总为字符串报告**；
4. API 层将 `XhsNoteReportResponse(report=final_report)` 封装为统一 `ApiResponse` 返回（**当前 `report` 为字符串**；`XhsNoteFinalReport` 已定义于 schemas，可供后续结构化响应或持久化使用）。

---

### 3. 数据模型设计（Pydantic）

所有数据模型放置于 `app/schemas/xhs_note.py`，分为：

- **请求模型（Request Schemas）**
- **响应模型（Response Schemas）**
- **领域模型（Domain Schemas，Agent/Task 间中间态）**

#### 3.1 请求模型

**说明**：接口采用 **POST + multipart/form-data**，**每次请求上传多张图片**（同一 form 字段名下多文件）。服务端解析 form 后，为每张上传的图片生成内部表示 `XhsImageInput`。

- **`XhsImageInput`**（服务端解析 form 后生成，不直接由客户端传 JSON）
  - `image_id: str`：服务端为每张上传图片分配的唯一标识（如 `img_0`、`img_1`）；
  - `file_name: str`：原始文件名（来自上传文件的 `filename`）；
  - `local_path: str`：本次请求内该图片的临时落盘路径（由服务端写入，供多模态 Agent 读取，请求结束后可清理）。

- **`XhsNoteIdeaRequest`**（由 form 解析后组装的领域请求）
  - `idea_text: str`：用户对笔记创作的自然语言描述 / 思路（对应 form 字段 `idea_text`）；
  - `images: list[XhsImageInput]`：本次上传的图片列表（由 form 中的多文件字段解析得到）；
  - `target_goal: str | None`：可选，对应 form 字段（如“带货转化 / 种草 / 个人 IP”）；
  - `constraints: dict[str, str] | None`：可选，对应 form 中 JSON 字符串解析结果，用于文案风格、长度、禁词等限制。

#### 3.2 视觉分析与图片编辑领域模型

参考 m2l5/m2l6 示例中的 `ImageAnalysis`，在本项目中拆分为两层：

- **`XhsImageVisualAnalysis`**
  - `image_id: str`
  - `file_name: str`
  - `subject_description: str`：主体内容客观描述；
  - `atmosphere_vibe: str`：情绪 / 氛围描述；
  - `visual_details: list[str]`：至少 3 个细节；
  - `image_quality_score: str`：1–10 分 + 理由；
  - `highlight_feature: str`：视觉锚点描述。

- **`XhsImageEditPlan`**
  - `image_id: str`
  - `file_name: str`
  - `overall_edit_strategy: str`：整体编辑思路（统一使用小红书自带内置编辑能力，不推荐外部 App），例如整体画面调性、风格方向；
  - `crop_suggestion: str`：剪裁建议（横竖构图选择、主体居中/偏移、留白位置等）；
  - `light_color_adjustment: str`：亮度 / 对比度 / 饱和度等基础参数调整建议（可给出“略微提升 / 明显降低”这类相对描述，而非具体数值）；
  - `filter_suggestion: str`：小红书内置滤镜建议（可给出滤镜系列名称或风格描述，如“偏日系冷调滤镜”“接近胶片感的暖调滤镜”）；
  - `text_overlay_suggestion: str`：文字建议（是否需要加文字、文字大致内容方向、出现的位置和数量控制，强调不要遮挡关键视觉锚点）；
  - `beauty_adjustment_suggestion: str`：美颜建议（仅在有人像时给出，如磨皮强度、瘦脸幅度等的相对建议，并明确“不过度美颜、保持自然感”原则）；
  - `is_recommended_as_cover: bool`：是否建议作为首图 / 封面（结合视觉锚点和信息承载力综合判断）；
  - `risk_and_pitfall_notes: str`：需要规避的审美风险 / 平台审核风险（如不过度裸露、避免违规文案、避免过度 PS 导致失真等）。

- **`XhsVisualBatchReport`**
  - `user_raw_intent: str`
  - `images_visual: list[XhsImageVisualAnalysis]`
  - `summary: str`（当前实现字段名，与代码一致；即整体视觉分析报告总结）

- **`XhsImageEditBatchReport`**
  - `images_edit_plan: list[XhsImageEditPlan]`
  - `summary: str`（当前实现字段名，即整体编辑方案总结）

#### 3.3 内容策略、文案与 SEO 领域模型

直接在现有 m2l5 示例模型基础上适度调整字段命名，以便与项目统一：

- **`XhsContentStrategyBrief`**
  - 与 `ContentStrategyBrief` 类似，保留以下关键字段：
    - `input_evaluation: str`
    - `target_audience_persona: str`
    - `core_pain_point: str`
    - `suggested_title: str`
    - `content_outline: list[str]`
    - `engagement_strategy: str`
    - `retention_strategy: str`
    - `seo_keywords: list[str]`

- **`XhsCopywritingOutput`**
  - `title: str`：带 Emoji 的小红书标题；
  - `content: str`：完整正文（支持多段落 + Emoji）；
  - `picture_order: list[str]`：按照发布顺序的图片 `image_id` 列表；
  - `highlight_hooks: list[str]`：文中关键“钩子句”列表（便于 AB 测试）。

- **`XhsSEOOptimizedNote`**
  - `optimization_summary: str`
  - `optimized_title: str`
  - `optimized_content: str`
  - `optimized_picture_order: list[str]`
  - `tags: list[str]`

#### 3.4 最终输出模型

- **`XhsImageWithPlans`**
  - `base_info: XhsImageInput`
  - `visual_analysis: XhsImageVisualAnalysis`
  - `edit_plan: XhsImageEditPlan`

- **`XhsNoteFinalReport`**
  - `idea_text: str`
  - `strategy_brief: XhsContentStrategyBrief`
  - `raw_copywriting: XhsCopywritingOutput`
  - `seo_optimized_note: XhsSEOOptimizedNote`
  - `images: list[XhsImageWithPlans]`

- **`XhsNoteReportResponse`**
  - 顶层响应数据结构。**当前实现**：仅包含 `report: str`（完整笔记撰写报告字符串），与项目统一 `ApiResponse[T]` 结合返回；`XhsNoteFinalReport` 已定义于 schemas，可供后续改为结构化 JSON 或持久化时使用。

---

### 4. Agent 设计

Agent 的 **角色文案（role、goal、backstory 等）** 配置在 `app/crews/config/agents.yaml`，**LLM、tools、multimodal** 等在 `app/crews/xhs_note/agents.py` 中绑定，遵循以下约定：

- 默认使用项目中的 `get_llm()`（阿里云通义）作为 LLM 封装；
- 多模态 Agent（视觉分析师 / 图片编辑师）使用 `model="qwen3-vl-plus"`，`multimodal=True`；
- 文案类 Agent（增长策略 / 内容撰写 / 搜索优化）**统一使用 `qwen3-max-2026-01-23`**，如需降级或灰度可通过配置切换；
- 各 Task 的 `output_pydantic` 在 `tasks.py` 中绑定到对应 Pydantic 模型；
- 实现上从 `agents.yaml` 读取配置后传入 `Agent(config=...)`，与 CrewAI 兼容。

#### 4.1 视觉分析师 Agent（多模态）

- **名称**：`xhs_visual_analyst`
- **角色**：`深小红书笔记MCN机构视觉分析师`
- **LLM**：`qwen3-vl-plus`（多模态），`multimodal=True`
- **核心职责**：
  - 针对单张图片输出 `XhsImageVisualAnalysis`；
  - 严格按照模型字段语义进行结构化输出；
  - 分析关注点：构图、光线、色彩、细节、情绪氛围、视觉锚点。
- **Prompt 设计要点**：
  - backstory 参考 m2l6 `image_analyst`，强调小红书场景、爆款审美标准；
  - 明确“只负责视觉分析，不负责内容策划或编辑方案”；
  - 所有输出使用中文，避免英混。

#### 4.2 图片编辑师 Agent（多模态）

- **名称**：`xhs_image_editor`
- **角色**：`小红书笔记MCN机构图片编辑师`
- **LLM**：`qwen3-vl-plus`（多模态），`multimodal=True`
- **核心职责**：
  - 基于原始图片和视觉分析结果，输出 `XhsImageEditPlan`；
  - 规划具体可落地的 P 图方案，要求能在常见 App 中实现；
  - 指出是否适合作为首图 / 封面。
- **Prompt 设计要点**：
  - backstory 强调对小红书平台审美、审核规则熟悉；
  - 要求输出中区分“整体方向”和“可执行步骤列表”；
  - 明确不能直接生成图片，仅给出编辑方案。

#### 4.3 资深小红书增长策略专家 Agent

- **名称**：`xhs_growth_strategist`
- **角色**：`资深小红书增长策略专家`
- **参考**：m2l5 中 `content_strategist`，并适配本项目字段 `XhsContentStrategyBrief`；
- **职责**：
  - 基于：`idea_text` + 视觉批量分析报告 + 图片编辑方案概要；
  - 生成一份完整的内容策略简报（受众画像、痛点、标题建议、内容大纲、互动与留存策略、SEO 关键词等）。

#### 4.4 资深 MCN 内容撰写编辑 Agent

- **名称**：`xhs_content_writer`
- **角色**：`资深MCN内容撰写编辑`
- **参考**：m2l5 中 `content_writer`，输出模型为 `XhsCopywritingOutput`；
- **职责**：
  - 严格遵循策略简报及视觉 / 编辑结果，撰写原始小红书笔记文案；
  - 输出带 Emoji 的标题与正文；
  - 产出排序后的 `picture_order`（按照爆款首图 + 信息层次进行排序）。

#### 4.5 资深小红书搜索优化专家 Agent

- **名称**：`xhs_seo_expert`
- **角色**：`资深小红书搜索优化专家`
- **参考**：m2l5 中 `seo_optimizer`，输出模型为 `XhsSEOOptimizedNote`；
- **职责**：
  - 在不牺牲文案质量前提下，对标题、正文、图片顺序、标签进行搜索优化；
  - 产出 5–8 个高价值标签；
  - 描述优化思路与搜索占位策略。

---

### 5. Task 设计与并发策略（与当前实现一致）

Task 定义与工厂函数集中在 `app/crews/xhs_note/tasks.py`，描述与预期输出从 `app/crews/config/tasks.yaml` 加载，颗粒度如下。

#### 5.1 图片视觉分析（按图拆 Task + 汇总）

- **工厂**：`build_visual_analysis_task(image, idea_text)` — 每张图一个 Task，`output_pydantic=XhsImageVisualAnalysis`，`async_execution=True`；
- **汇总**：`build_visual_analysis_summary_task(context)` — 依赖前述所有视觉分析 Task，输出一句话总结（当前为字符串，非 Pydantic）；
- 在 `flows.py` 中，阶段一使用一个 Crew，tasks = [ 每图 Task…, summary Task ]，`Process.sequential`，执行后按 `image_id` 索引得到 `visual_by_id` 与 `visual_summary`。

#### 5.2 图片编辑方案（按图拆 Task + 汇总）

- **工厂**：`build_image_edit_task(idea_text, image, visual)` — 每张图一个 Task，`output_pydantic=XhsImageEditPlan`，`async_execution=True`；
- **汇总**：`build_image_edit_plan_summary_task(context)` — 依赖前述所有编辑方案 Task，输出一句话总结；
- 阶段二同样单 Crew、sequential，得到 `edit_by_id` 与 `edit_summary`。

#### 5.3 内容策略报告任务

- **任务名**：`task_content_strategy`
- **Agent**：`xhs_growth_strategist`
- **输入**：由 `crew.akickoff(inputs={"idea_text", "visual_report", "edit_report"})` 注入（visual_report / edit_report 为阶段一、二的批次报告 JSON）。
- **输出**：`output_pydantic=XhsContentStrategyBrief`

#### 5.4 笔记正文撰写任务

- **任务名**：`task_copywriting`
- **Agent**：`xhs_content_writer`
- **context**：`[task_content_strategy]`
- **输出**：`output_pydantic=XhsCopywritingOutput`

#### 5.5 搜索优化任务

- **任务名**：`task_seo_optimization`
- **Agent**：`xhs_seo_expert`
- **context**：`[task_content_strategy, task_copywriting]`
- **输出**：`output_pydantic=XhsSEOOptimizedNote`

#### 5.6 最终报告

- **当前实现**：无独立 `task_final_report_assembly`；在 `flows.py` 内由 Python 函数 `_generate_final_report(idea_request, edit_batch, seo_note)` 将策略、文案、SEO 与编辑方案等**汇总为字符串报告**，作为 API 的 `report` 字段返回。

所有带结构化输出的 Task 均指定 `output_pydantic`，确保 CrewAI 返回可解析的 Pydantic 结果。

---

### 6. 流程编排（当前实现：三阶段、三 Crew）

在 `app/crews/xhs_note/flows.py` 中，**不采用单 Crew 六 Task**，而是**三阶段、三个 Crew**：

1. **阶段一 `_run_visual_analysis_phase`**  
   - 为每张图片构建 `build_visual_analysis_task(img, idea_text)`，再追加 `build_visual_analysis_summary_task(tasks)`；  
   - 单 Crew：agents=`[xhs_visual_analyst]`，tasks=上述列表，`Process.sequential`；  
   - 使用 `crew.akickoff()`（配合 `asyncio.wait_for` 超时），从 `tasks_output` 解析每图 `XhsImageVisualAnalysis` 与汇总字符串。

2. **阶段二 `_run_image_edit_phase`**  
   - 为每张图（且已有视觉分析结果）构建 `build_image_edit_task(idea_text, img, visual)`，再追加 `build_image_edit_plan_summary_task(tasks)`；  
   - 单 Crew：agents=`[xhs_image_editor]`，tasks=上述列表，`Process.sequential`；  
   - 解析得到每图 `XhsImageEditPlan` 与编辑方案总结字符串。

3. **阶段三 `_run_content_phase`**  
   - 单 Crew：agents=`[xhs_growth_strategist, xhs_content_writer, xhs_seo_expert]`，tasks=`[task_content_strategy, task_copywriting, task_seo_optimization]`，`Process.sequential`；  
   - 通过 `crew.akickoff(inputs={"idea_text", "visual_report", "edit_report"})` 注入阶段一、二汇总的 `XhsVisualBatchReport` / `XhsImageEditBatchReport` 的 JSON；  
   - 从 `result.tasks_output` 依次取 `XhsContentStrategyBrief`、`XhsCopywritingOutput`、`XhsSEOOptimizedNote`。

4. **最终报告**  
   - 在 Python 内调用 `_generate_final_report(idea_request, edit_batch, seo_note)` 生成**字符串报告**，并返回给 API。

每阶段均使用 `Process.sequential`；多图“并发”通过**每图一个 Task、同一 Crew 内顺序执行**实现，整体由 `run_xhs_note_flow` 异步串联三阶段。

---

### 7. API 设计

#### 7.1 Endpoint 定义

- **URL**：`POST /api/v1/xhs/notes/report`
- **鉴权**：Header `X-API-Key: <key>`（复用 `security.py` 中 API Key 中间件逻辑）
- **请求体**：**仅支持 `multipart/form-data`**。**每次请求上传多张图片**，图片随 POST 的 form 表单一起提交。

**Form 字段说明**：

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `idea_text` | text | 是 | 笔记创作意图 / 自然语言描述 |
| `images` | file（多文件） | 是 | **多张图片**：同一字段名 `images` 下上传多份文件，至少 1 张，上限由 `APP_XHS_MAX_IMAGES` 控制（默认 20） |
| `target_goal` | text | 否 | **预留**：补充目标（如“带货转化 / 种草 / 个人 IP”），当前实现未解析 |
| `constraints` | text | 否 | **预留**：JSON 字符串约束，当前实现未解析 |

**当前实现**：API 仅必填 `idea_text`、`images`；`target_goal`、`constraints` 可在后续版本接入。

服务端处理流程：接收上传文件 → 写入临时目录（`APP_DATA_OUTPUT_DIR/xhs_note/<run_id>`）→ 可选图片压缩（`APP_XHS_IMAGE_MAX_SIZE`、`APP_XHS_IMAGE_QUALITY`）→ 为每张图片分配 `image_id`、记录 `file_name` 与 `local_path` → 组装为 `XhsNoteIdeaRequest` 进入 `run_xhs_note_flow`。请求结束后清理临时目录。

#### 7.2 请求示例（Form 表单）

使用 `multipart/form-data` 时，请求示意如下（具体以实际 form 字段名为准）：

- **idea_text**（文本）：`想写一篇关于独居女生夜晚下班后疗愈时光的小红书笔记，主打氛围感和情绪价值，带一点生活方式种草。`
- **target_goal**（文本）：`种草+情绪陪伴`
- **images**（文件）：第 1 个文件 `cup_001.jpg`，第 2 个文件 `cup_002.jpg`（同一字段名上传多文件）
- **constraints**（文本，可选）：`{"max_length":"正文不超过1200字","forbidden_words":"不要出现价格、购买链接等直接导购内容"}`

#### 7.3 响应示例（当前实现）

统一走 `ApiResponse[XhsNoteReportResponse]`，其中 `XhsNoteReportResponse` 仅含 `report: str`。示例：

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "report": "原始创作意图: ...\n生成笔记标题: ...\n生成笔记正文: ...\n生成笔记图片顺序: ...\n生成笔记标签: ...\n生成笔记图片编辑方案: \n图片ID: img_0\n..."
  },
  "request_id": "..."
}
```

**说明**：当前 `data.report` 为**整篇笔记撰写报告字符串**（含标题、正文、图片顺序、标签及每张图的编辑方案等）。完整结构化模型 `XhsNoteFinalReport` 已定义于 `schemas/xhs_note.py`，可供后续改为 JSON 或持久化时使用。

---

### 8. 配置、可观测性与错误处理

- **配置管理**：
  - 复用 `Settings`（`app/core/config.py`），与小红书笔记相关的项包括：
    - `APP_LLM_*`：文案类 Agent 在代码中固定使用 `qwen3-max-2026-01-23`，多模态 Agent 使用 `qwen3-vl-plus`；
    - `APP_XHS_IMAGE_MAX_SIZE`：多模态调用前图片压缩长边最大像素，默认 `1024`，0 表示不缩放；
    - `APP_XHS_IMAGE_QUALITY`：有损压缩质量 1–100，默认 `85`；
    - `APP_XHS_MAX_IMAGES`：单次请求最大图片数，默认 `20`；
    - `APP_CREW_EXECUTION_TIMEOUT`：CrewAI 单阶段执行超时（秒），默认 `600`；
    - `APP_DATA_OUTPUT_DIR`：AI 应用输出数据目录，小红书笔记使用其下 `xhs_note/<run_id>`。
- **日志与监控**：
  - 对 `XhsNoteCrewFlow.run()` 增加埋点：
    - 记录 `request_id`、图片数量、总耗时、各 Task 耗时；
    - 将 token 消耗计入 `ai_token_usage_total`；
  - 若启用 Prometheus，可为本项目增加独立指标标签（如 `crew_name="xhs_note"`）。
- **错误处理**：
  - 请求入参校验失败 → 返回 422；
  - 上游 LLM 调用失败 / 超时 → 返回 503 或 500，并在 `error.log` 中记录详细堆栈与 trace id；
  - 对单张图片分析失败时，可选择：
    - 直接报错终止；
    - 或标记该图片为失败并在最终报告中体现（可作为后续版本增强点）。

---

### 9. 开发与测试计划

- **开发步骤建议**：
  1. 在 `schemas/xhs_note.py` 中实现所有 Pydantic 模型；
  2. 在 `crews/xhs_note/agents.py` 中完成 5 个 Agent 定义，复用 m2l5/m2l6 prompt 模版；
  3. 在 `crews/xhs_note/tasks.py` 中实现 6 个 Task（含批量并发逻辑的 2 个图片任务）；
  4. 在 `crews/xhs_note/flows.py` 中实现 `create_xhs_note_crew` 和对外的 `run` 方法；
  5. 在 `services/xhs_note_service.py` 中封装调用逻辑、错误处理和日志埋点；
  6. 在 `api/v1/xhs_note.py` 中暴露 HTTP API 并接入路由。

- **测试策略**：
  - 单元测试：
    - Schemas 校验（字段必填 / 默认值）；
    - Service 层在 Mock Crew 的情况下的入参 / 出参转换；
  - 集成测试：
    - 端到端调用 `POST /api/v1/xhs/notes/report`，在启用真实 LLM（或 Mock LLM）的情况下验证流程；
    - 极端情况：0 张图片、超过最大图片数、图片路径无效等；
  - 性能测试：
    - 在 N 张图片（如 3、5、10）场景下，验证异步并发带来的整体耗时控制；
    - 对比串行与并发的执行时间差异，评估资源 / 成本。

---

### 10. 迭代方向与扩展性

- 支持多轮交互：在初版报告基础上，让用户通过追加指令微调标题 / 正文 / 标签；
- 支持多平台适配：在现有小红书模版基础上，扩展到抖音 / 微博等平台的内容模版；
- 支持结果持久化与后台管理：结合 OceanBase 持久化，构建历史报告检索与复用能力；
- 支持 A/B 测试方案自动生成：让 Agent 输出多套标题 / 首图组合用于实测转化。

本设计文档对“小红书爆款笔记多 Agent 生成项目”的核心模块、Agent 与 Task 设计、编排流程、数据结构以及 API 接入方式进行了详细定义，可作为后续实现与 Code Review 的统一参考基线。

---

### 文档与实现对齐说明（最近更新）

本文档已按当前代码实现做了对齐修订，主要差异与约定如下：

- **Agent**：角色文案在 `config/agents.yaml`，LLM/tools/multimodal 在 `agents.py`。
- **Task**：按图构建的工厂函数 + 两个 summary Task + 内容三 Task；描述与预期输出来自 `config/tasks.yaml`。
- **流程**：三阶段、三个 Crew（视觉分析 → 编辑方案 → 内容策略/文案/SEO），最终报告由 `_generate_final_report` 在 Python 内生成字符串。
- **API 响应**：当前返回 `data.report` 为字符串；`XhsNoteFinalReport`、`XhsVisualBatchReport.summary`、`XhsImageEditBatchReport.summary` 等与代码一致。
- **Form**：当前仅使用 `idea_text`、`images`；`target_goal`、`constraints` 为预留。

