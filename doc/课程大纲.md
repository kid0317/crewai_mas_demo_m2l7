# 小红书爆款笔记生成 Agent 实战课程大纲

> 课程时长：约 40 分钟
> 课程定位：系列课程中的实战项目课，学员已具备 CrewAI 基础概念
> 教学目标：从零搭建一个多 Agent 协作的小红书爆款笔记生成系统

---

## 时间分配总览

| 章节 | 时间 | 内容概要 |
|------|------|----------|
| 开场导入 | 0:00 – 2:00 | 展示最终效果，明确学习目标 |
| 第一章 | 2:00 – 7:00 | 项目架构设计：分层结构与请求链路 |
| 第二章 | 7:00 – 13:00 | 数据模型设计：用 Pydantic 定义 Agent 的结构化输出 |
| 第三章 | 13:00 – 22:00 | Agent 设计：5 个角色的定义、YAML 配置与工厂模式 |
| 第四章 | 22:00 – 28:00 | Task 设计：YAML 模板化描述与结构化输出绑定 |
| 第五章 | 28:00 – 36:00 | 流程编排：三阶段 Crew 协作（并发 + 串行） |
| 第六章 | 36:00 – 39:00 | 服务与 API 集成：从 HTTP 请求到最终报告 |
| 总结 | 39:00 – 40:00 | 核心要点回顾与课后思考 |

---

## 开场导入（2 分钟）

- 展示最终产出效果：用户上传图片 + 一句话意图 → 生成完整的小红书笔记报告
- 报告包含：SEO 优化标题、正文、标签、图片顺序、每张图片的编辑方案
- 点明核心技术：5 个 Agent 分工协作，三阶段流程编排
- 本节课学什么：从数据模型 → Agent → Task → Flow → API，一步步搭建完整系统

---

## 第一章：项目架构设计（5 分钟）

### 1.1 分层架构
- API 层（FastAPI）→ Service 层 → Flow 编排层 → Agent/Task 层 → LLM 层
- 每层职责清晰，单向依赖

### 1.2 请求链路总览
- `POST /api/v1/xhs/notes/report` → 图片保存压缩 → 构建领域模型 → 三阶段 Crew 执行 → 汇总报告 → 返回响应
- 对应代码文件：`xhs_note.py` → `xhs_note_service.py` → `flows.py` → `agents.py` + `tasks.py`

### 1.3 关键文件一览
- `schemas/xhs_note.py`：数据模型
- `crews/config/agents.yaml`：Agent 角色配置
- `crews/config/tasks.yaml`：Task 描述模板
- `crews/xhs_note/agents.py`：Agent 工厂
- `crews/xhs_note/tasks.py`：Task 工厂
- `crews/xhs_note/flows.py`：流程编排

---

## 第二章：数据模型设计（6 分钟）

### 2.1 为什么先定义数据模型
- Agent 的结构化输出依赖 Pydantic 模型
- 模型就是 Agent 之间的"接口契约"
- 先定义数据结构，再设计 Agent 和 Task

### 2.2 输入模型
- `XhsImageInput`：单张图片信息（image_id, file_name, local_path）
- `XhsNoteIdeaRequest`：用户请求（idea_text + images 列表）

### 2.3 Agent 输出模型（核心，逐个讲解）
- `XhsImageVisualAnalysis`：视觉分析结果（主体描述、氛围、细节、质量评分、亮点）
- `XhsImageEditPlan`：图片编辑方案（裁剪、调色、滤镜、文字、美颜、首图推荐、风险）
- `XhsContentStrategyBrief`：内容策略简报（目标人群、痛点、标题、大纲、SEO 关键词）
- `XhsCopywritingOutput`：文案产出（标题、正文、图片顺序、钩子句）
- `XhsSEOOptimizedNote`：SEO 优化后的最终笔记（优化标题、正文、标签）

### 2.4 聚合模型
- `XhsVisualBatchReport`：多图视觉分析批量报告
- `XhsImageEditBatchReport`：多图编辑方案批量报告
- 作用：将逐图结果汇总后传递给下游内容阶段

---

## 第三章：Agent 设计（9 分钟）

### 3.1 五个 Agent 的角色分工
| Agent | 角色定位 | 模型 | 是否多模态 |
|-------|---------|------|-----------|
| 视觉分析师 | 从平台审美+情绪价值+商业转化三重视角分析图片 | qwen3-vl-plus | 是 |
| 图片编辑师 | 轻量可复现的编辑方案，统一笔记视觉风格 | qwen3-vl-plus | 是 |
| 增长策略专家 | 制定内容策略简报，指导爆款创作 | qwen3-max | 否 |
| 内容撰写师 | 将策略转译为高情绪价值的笔记文案 | qwen3-max | 否 |
| SEO 优化专家 | 自然融入长尾关键词，优化搜索与推荐 | qwen3-max | 否 |

### 3.2 YAML 配置：role / goal / backstory
- 展示 `agents.yaml` 中一个 Agent 的完整配置
- backstory 的四段式结构：身份背景 → 关键知识 → 工作方法 → 行为边界
- 为什么 backstory 这么长：prompt engineering 的核心

### 3.3 Python 工厂函数
- 展示 `get_xhs_visual_analyst()` 的实现
- 关键参数：`config` 来自 YAML，`llm` / `tools` / `multimodal` 在代码中绑定
- 为什么用工厂模式而非单例：避免并发状态共享

### 3.4 工具绑定
- `AddImageToolLocal`：加载本地图片为 base64 数据 URL，支持多模态分析
- `IntermediateTool`：保存中间思考过程，辅助分步推理

---

## 第四章：Task 设计（6 分钟）

### 4.1 YAML 模板化描述
- 展示 `tasks.yaml` 中 `task_visual_analysis` 的配置
- 变量占位符：`{idea_text}`、`{images_info}`、`{visual_analysis}`
- `expected_output` 的输出格式约束（纯 JSON，无代码块标记）

### 4.2 Task 工厂函数
- 展示 `build_visual_analysis_task()` 的实现
- 描述模板 + 变量替换 → 完整 Task
- `output_pydantic` 绑定：让 CrewAI 自动将 LLM 输出解析为 Pydantic 模型
- `async_execution=True`：标记可并发执行

### 4.3 Task 间的依赖关系
- 内容阶段三个 Task 的 `context` 依赖链
- `get_task_copywriting(strategy_task)` → 文案依赖策略
- `get_task_seo_optimization(strategy_task, copywriting_task)` → SEO 依赖策略和文案

### 4.4 七个 Task 速览
| Task | Agent | 输入 | 输出 | 并发 |
|------|-------|------|------|------|
| 视觉分析 | 视觉分析师 | 单图+意图 | XhsImageVisualAnalysis | 是 |
| 视觉分析总结 | 视觉分析师 | 所有分析结果 | 一句话总结 | 否 |
| 图片编辑方案 | 图片编辑师 | 单图+意图+视觉分析 | XhsImageEditPlan | 是 |
| 编辑方案总结 | 图片编辑师 | 所有编辑方案 | 一句话总结 | 否 |
| 内容策略 | 增长策略专家 | 意图+视觉报告+编辑报告 | XhsContentStrategyBrief | 否 |
| 文案撰写 | 内容撰写师 | 策略简报（context） | XhsCopywritingOutput | 否 |
| SEO 优化 | SEO 专家 | 策略+文案（context） | XhsSEOOptimizedNote | 否 |

---

## 第五章：流程编排（8 分钟）

### 5.1 三阶段架构设计
```
阶段一：视觉分析（多图并发）
  N张图片 → N个视觉分析Task + 1个总结Task → 1个Crew → visual_by_id

阶段二：图片编辑（多图并发）
  N张图片 → N个编辑方案Task + 1个总结Task → 1个Crew → edit_by_id

阶段三：内容创作（顺序执行）
  策略 → 文案 → SEO → 1个Crew → 最终笔记
```

### 5.2 阶段一：视觉分析阶段
- 代码走读 `_run_visual_analysis_phase()`
- 为每张图创建独立的 Task + Agent 实例
- 单个 Crew 内 sequential 执行，但 async_execution=True 允许 LLM 并发
- 超时控制：`asyncio.wait_for(crew.akickoff(), timeout=600)`
- 结果提取：遍历 `tasks_output`，取 `.pydantic` 字段

### 5.3 阶段二：图片编辑阶段
- 与阶段一结构类似
- 关键区别：每个 Task 的输入包含阶段一的视觉分析结果

### 5.4 阶段三：内容创作阶段
- 代码走读 `_run_content_phase()`
- 汇总前两阶段结果为 JSON 字符串，通过 `inputs` 传入 Crew
- 三个 Task 的 context 依赖链保证顺序执行
- 最终结果：策略简报 + 文案 + SEO 优化笔记

### 5.5 汇总最终报告
- `_generate_final_report()` 将 SEO 优化结果 + 编辑方案组装为最终文本
- `run_xhs_note_flow()` 作为对外统一入口

---

## 第六章：服务与 API 集成（3 分钟）

### 6.1 Service 层
- `generate_xhs_note_report()`：图片保存、压缩、调用 flow、清理临时文件
- 图片压缩：Pillow 缩放长边到 1024px + JPEG 质量 85

### 6.2 API 端点
- `POST /api/v1/xhs/notes/report`
- `multipart/form-data`：`idea_text` + 多文件 `images`
- 统一响应：`ApiResponse[XhsNoteReportResponse]`（code + message + data + request_id）

### 6.3 错误处理
- Service 层 try/finally 确保临时文件清理
- Flow 层 try/except 记录 Prometheus 指标
- API 层区分业务错误（code=1）和系统异常（500）

---

## 总结（1 分钟）

### 核心要点回顾
1. **数据模型先行**：Pydantic Schema 是 Agent 间的接口契约
2. **角色设计是灵魂**：backstory 的深度决定了 Agent 的专业度
3. **YAML + Python 分离**：文案在 YAML，结构在 Python
4. **工厂模式避免状态共享**：每次调用创建新实例
5. **三阶段编排**：并发处理图片，串行创作内容
6. **结构化输出**：`output_pydantic` 让 LLM 输出可编程消费

### 课后思考
- 如果要新增一个"评论区互动话术生成"Agent，应该加在哪个阶段？
- 如果图片数量很多（比如 20 张），如何优化并发策略？
